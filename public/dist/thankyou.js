(()=>{"use strict";const t=new class{constructor(){this.API_HOST="https://api.appworks-school.tw/api/1.0",this.accessToken=void 0}async getProducts(t,e){const s=await fetch(`${this.API_HOST}/products/${t}?paging=${e}`);return await s.json()}async getCampaigns(){const t=await fetch(`${this.API_HOST}/marketing/campaigns`);return await t.json()}async searchProducts(t,e){const s=await fetch(`${this.API_HOST}/products/search?keyword=${t}&paging=${e}`);return await s.json()}async getProduct(t){const e=await fetch(`${this.API_HOST}/products/details?id=${t}`);return await e.json()}async checkout(t){if(!this.accessToken)throw new Error("請先登入");const e=await fetch(`${this.API_HOST}/order/checkout`,{body:JSON.stringify(t),headers:new Headers({"Content-Type":"application/json",Authorization:`Bearer ${this.accessToken}`}),method:"POST"});if(401===e.status)throw new Error("請先登入");if(403===e.status)throw new Error("內容錯誤或權限不足");return await e.json()}async signin(t){const e=await fetch(`${this.API_HOST}/user/signin`,{body:JSON.stringify(t),headers:new Headers({"Content-Type":"application/json"}),method:"POST"}),s=await e.json();return this.accessToken=s.data.access_token,s}};new class extends class{constructor(t,e,s,a){this.model=t,this.view=e,this.fb=s,this.tappay=a,this.view.bindInputSearchPressEnter(this.redirectToIndexPageWithTag),this.view.bindClickProfile(this.handleClickProfile.bind(this))}init(){this.view.handleTag(this.paramsTag),this.view.renderCount(this.model.cart.items.length)}get paramsNumber(){return this.getParams("number")}get paramsId(){return this.getParams("id")}get paramsTag(){return this.getParams("tag")||"all"}getParams(t){return new URLSearchParams(window.location.search).get(t)}redirectToIndexPageWithTag(t){window.location.href=`/?tag=${t}`}async handleClickProfile(){this.fb.jwtToken?window.location.href="/profile.html":await this.fb.login()&&window.alert("登入成功！")}}{constructor(t,e,s,a){super(t,e,s,a)}init(){super.init(),this.fb.init(),this.view.renderNumber(this.paramsNumber)}}(new class extends class{constructor(t){this.cart=t}}{constructor(t){super(t)}}(new class{constructor(){this.items=JSON.parse(window.localStorage.getItem("cart")||"[]")}static calculateSubtotal(t){return t.reduce(((t,e)=>t+e.qty*e.price),0)}update(){window.localStorage.setItem("cart",JSON.stringify(this.items))}}),new class extends class{constructor(){this.tagMen=this.getElement(".tag-men"),this.tagWomen=this.getElement(".tag-women"),this.tagAccessories=this.getElement(".tag-accessories"),this.inputSearch=this.getElement("input#search"),this.profile=this.getElement("#profile"),this.count=this.getElement(".count")}createElement(t,e){const s=document.createElement(t);return e.classList&&s.classList.add(...e.classList),e.attributes&&Object.entries(e.attributes).forEach((([t,e])=>{s.setAttribute(t,e)})),e.styles&&Object.entries(e.styles).forEach((([t,e])=>{s.style[t]=e})),e.children&&s.append(...e.children),e.parent&&e.parent.append(s),s}getElement(t){return document.querySelector(t)}handleTag(t){switch(t){case"men":this.tagMen.classList.add("tag--active");break;case"women":this.tagWomen.classList.add("tag--active");break;case"accessories":this.tagAccessories.classList.add("tag--active");break;case"all":break;default:this.inputSearch.value=t}}bindInputSearchPressEnter(t){this.inputSearch.addEventListener("keydown",(e=>{13===e.keyCode&&t(e.currentTarget.value)}))}bindClickProfile(t){this.profile.addEventListener("click",(()=>{t()}))}renderCount(t){this.count.textContent=t}}{constructor(){super(),this.number=this.getElement("#number")}renderNumber(t){this.number.textContent=t}},new class{constructor(){this.jwtToken=void 0}loadSdk(){var t,e,s,a,i;e="script",s="facebook-jssdk",i=(t=document).getElementsByTagName(e)[0],t.getElementById(s)||((a=t.createElement(e)).id=s,a.src="https://connect.facebook.net/zh_TW/sdk.js",i.parentNode.insertBefore(a,i))}async init(){await new Promise((t=>{window.fbAsyncInit=t,this.loadSdk()})),window.FB.init({appId:"700590737403665",cookie:!0,xfbml:!0,version:"v10.0"});const t=await new Promise((t=>{window.FB.getLoginStatus(t)}));return await this.handleLoginStatus(t)}async login(){const t=await new Promise((t=>{window.FB.login(t,{scope:"public_profile,email"})}));return await this.handleLoginStatus(t)}async handleLoginStatus(e){if("connected"===e.status){const{data:s}=await t.signin({provider:"facebook",access_token:e.authResponse.accessToken});return this.jwtToken=s.access_token,s.user}}async logout(){await new Promise((t=>{window.FB.logout(t)}))}},new class{constructor(){this.appId="12348",this.appKey="app_pa1pQcKoY22IlnSXq5m5WP5jFKzoRG58VEXpT7wU62ud7mMbDOGzCYIlzzLF",this.serverType="sandbox"}setupSdk(){window.TPDirect.setupSDK(this.appId,this.appKey,this.serverType)}setupCard(){window.TPDirect.card.setup({fields:{number:{element:"#card-number",placeholder:"**** **** **** ****"},expirationDate:{element:"#card-expiration-date",placeholder:"MM / YY"},ccv:{element:"#card-ccv",placeholder:"後三碼"}},styles:{".valid":{color:"green"},".invalid":{color:"red"}}})}init(){this.setupSdk(),this.setupCard()}getPrime(){return new Promise((t=>{window.TPDirect.card.getPrime((e=>{0===e.status&&t(e.card.prime)}))}))}get canGetPrime(){return window.TPDirect.card.getTappayFieldsStatus().canGetPrime}get cannotGetPrimeReason(){const t=window.TPDirect.card.getTappayFieldsStatus();return 1===t.status.number?"請輸入信用卡號碼":2===t.status.number?"信用卡號碼有誤":1===t.status.expiry?"請輸入有效期限":2===t.status.expiry?"有效期限有誤":1===t.status.ccv?"請輸入安全碼":2===t.status.ccv?"安全碼有誤":void 0}}).init()})();