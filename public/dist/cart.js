(()=>{"use strict";const t=new class{constructor(){this.API_HOST="https://api.appworks-school.tw/api/1.0"}async getProducts(t,e){const i=await fetch(`${this.API_HOST}/products/${t}?paging=${e}`);return await i.json()}async getCampaigns(){const t=await fetch(`${this.API_HOST}/marketing/campaigns`);return await t.json()}async searchProducts(t,e){const i=await fetch(`${this.API_HOST}/products/search?keyword=${t}&paging=${e}`);return await i.json()}async getProduct(t){const e=await fetch(`${this.API_HOST}/products/details?id=${t}`);return await e.json()}async checkout(t){const e=await fetch(`${this.API_HOST}/order/checkout`,{body:JSON.stringify(t),headers:{"content-type":"application/json"},method:"POST"});return await e.json()}async signin(t){const e=await fetch(`${this.API_HOST}/user/signin`,{body:JSON.stringify(t),headers:{"content-type":"application/json"},method:"POST"});return await e.json()}},e=class{constructor(){this.cartItems=JSON.parse(window.localStorage.getItem("cart")||"[]"),this.renderCart(this.cartItems)}static calculateSubtotal(t){return t.reduce(((t,e)=>t+e.qty*e.price),0)}renderCart(t){document.querySelector(".count").textContent=t.length}getItems(){return this.cartItems}setItems(t){this.cartItems=t,this.renderCart(this.cartItems),window.localStorage.setItem("cart",JSON.stringify(this.cartItems))}};new class{constructor(t,e,i){this.model=t,this.view=e,this.tappay=i,this.onCartItemsChanged(this.model.cart.getItems()),this.view.bindClickCheckout(this.handleClickCheckout.bind(this)),this.tappay.setup()}onCartItemsChanged(t){this.view.renderCartItems(t),this.view.bindChangeItemSelect(this.handleChangeItemQuantity.bind(this)),this.view.bindClickItemRemove(this.handleRemoveItem.bind(this))}handleChangeItemQuantity(t,e){this.model.changeCartItemQuantity(t,e),this.onCartItemsChanged(this.model.cart.getItems())}handleRemoveItem(t){this.model.removeCartItem(t),this.onCartItemsChanged(this.model.cart.getItems())}makeCheckoutData(t,i,s){const a=e.calculateSubtotal(i);return{prime:t,order:{shipping:"delivery",payment:"credit_card",subtotal:a,freight:60,total:a+60,recipient:s,list:i}}}async handleClickCheckout(e){const i=this.model.cart.getItems();if(this.tappay.canGetPrime){let s;try{s=await this.tappay.getPrime()}catch(t){window.alert(t)}const a=this.makeCheckoutData(s,i,e);t.checkout(a).then((({data:{number:t}})=>{this.model.cart.setItems([]),window.location.href=`/thankyou.html?number=${t}`}))}else window.alert(this.tappay.cannotGetPrimeReason)}}(new class extends class{constructor(){this.cart=new e}}{constructor(){super()}changeCartItemQuantity(t,e){const i=this.cart.getItems();i[t].qty=e,this.cart.setItems(i)}removeCartItem(t){const e=this.cart.getItems();e.splice(t,1),this.cart.setItems(e),window.alert("已從購物車移除")}},new class extends class{constructor(){this.fb=new class{constructor(){window.fbAsyncInit=this.init.bind(this),this.auth=void 0}setup(t){this.getLoginStatusCallback=t,this.loadSdk()}loadSdk(){var t,e,i,s,a;e="script",i="facebook-jssdk",a=(t=document).getElementsByTagName(e)[0],t.getElementById(i)||((s=t.createElement(e)).id=i,s.src="https://connect.facebook.net/zh_TW/sdk.js",a.parentNode.insertBefore(s,a))}init(){window.FB.init({appId:"700590737403665",cookie:!0,xfbml:!0,version:"v3.1"}),window.FB.getLoginStatus((t=>{this.handleLoginStatus(t),"function"==typeof this.getLoginStatusCallback&&(this.auth?this.getProfile().then((t=>{this.getLoginStatusCallback(t)})):window.location.href="/")}))}handleLoginStatus(t){"connected"===t.status&&(this.auth=t.authResponse,this.loginToServer())}handleClickProfile(){this.auth?window.location.href="/profile.html":this.loginToFb()}loginToFb(){window.FB.login((t=>{this.handleLoginStatus(t)}),{scope:"public_profile,email"})}loginToServer(){t.signin({provider:"facebook",access_token:this.auth.accessToken})}getProfile(){return new Promise(((t,e)=>{window.FB.api("/me?fields=id,name,email,picture.height(2048)",(i=>{i.error?e(i.error):t(i)}))}))}},this.tag=this.getTag(),this.inputSearch=this.getElement("input#search"),this.tagMen=this.getElement(".tag-men"),this.tagWomen=this.getElement(".tag-women"),this.tagAccessories=this.getElement(".tag-accessories"),this.profile=this.getElement("#profile"),this.setTag(),this.bindInputSearchKeydown(),this.bindClickProfile(this.fb.handleClickProfile.bind(this.fb))}setTag(){switch(this.tag){case"men":this.tagMen.classList.add("tag--active");break;case"women":this.tagWomen.classList.add("tag--active");break;case"accessories":this.tagAccessories.classList.add("tag--active");break;default:this.getElement("input#search").value=this.tag}}bindInputSearchKeydown(){this.inputSearch.addEventListener("keydown",(t=>{13===t.keyCode&&(window.location.href=`/?tag=${t.currentTarget.value}`)}))}bindClickProfile(t){this.profile.addEventListener("click",(()=>{t()}))}getTag(){return new URLSearchParams(window.location.search).get("tag")}createElement(t,e){const i=document.createElement(t);return e.classList&&i.classList.add(...e.classList),e.attributes&&Object.entries(e.attributes).forEach((([t,e])=>{i.setAttribute(t,e)})),e.styles&&Object.entries(e.styles).forEach((([t,e])=>{i.style[t]=e})),e.children&&i.append(...e.children),e.parent&&e.parent.append(i),i}getElement(t){return document.querySelector(t)}}{constructor(){super(),this.items=this.getElement("#items"),this.cartTitle=this.getElement("#title"),this.cartSubtotal=this.getElement("#subtotal span"),this.cartTotal=this.getElement("#total span"),this.checkout=this.getElement("#checkout"),this.itemSelectList=void 0,this.itemRemoveList=void 0,this.fb.setup()}renderCartItems(t){this.items.innerHTML="",this.itemSelectList=[],this.itemRemoveList=[],t.forEach((t=>{const e=this.createElement("select",{children:new Array(t.stock).fill().map(((e,i)=>{const s={value:i+1};return i+1===t.qty&&(s.selected="selected"),this.createElement("option",{children:[i+1],attributes:s})}))});this.itemSelectList.push(e);const i=this.createElement("div",{classList:["item__remove"],children:[this.createElement("img",{attributes:{src:"./images/cart-remove.png"}})]});this.itemRemoveList.push(i),this.createElement("div",{classList:["item"],parent:this.items,children:[this.createElement("img",{classList:["item__image"],attributes:{src:t.image}}),this.createElement("div",{classList:["item__detail"],children:[this.createElement("div",{classList:["item__name"],children:[t.name]}),this.createElement("div",{classList:["item__id"],children:[t.id]}),this.createElement("div",{classList:["item__color"],children:[`顏色｜${t.color.name}`]}),this.createElement("div",{classList:["item__size"],children:[`尺寸｜${t.size}`]})]}),this.createElement("div",{classList:["item__quantity"],children:[this.createElement("div",{classList:["mobile-text"],children:["數量"]}),e]}),this.createElement("div",{classList:["item__price"],children:[this.createElement("div",{classList:["mobile-text"],children:["單價"]}),`NT.${t.price}`]}),this.createElement("div",{classList:["item__subtotal"],children:[this.createElement("div",{classList:["mobile-text"],children:["小計"]}),"NT."+t.price*t.qty]}),i]})}));const i=e.calculateSubtotal(t);this.cartTitle.textContent=`購物車(${t.length})`,this.cartSubtotal.textContent=i,this.cartTotal.textContent=i+60}bindChangeItemSelect(t){this.itemSelectList.forEach(((e,i)=>{e.addEventListener("change",(e=>{t(i,Number(e.target.value))}))}))}bindClickItemRemove(t){this.itemRemoveList.forEach(((e,i)=>{e.addEventListener("click",(e=>{t(i)}))}))}bindClickCheckout(t){this.checkout.addEventListener("click",(()=>{const e={name:this.getElement("#name").value,phone:this.getElement("#phone").value,email:this.getElement("#email").value,address:this.getElement("#address").value,time:this.getElement("input[name=time]:checked").value};t(e)}))}},new class{constructor(){this.appId="12348",this.appKey="app_pa1pQcKoY22IlnSXq5m5WP5jFKzoRG58VEXpT7wU62ud7mMbDOGzCYIlzzLF",this.serverType="sandbox"}setupSdk(){window.TPDirect.setupSDK(this.appId,this.appKey,this.serverType)}setupCard(){window.TPDirect.card.setup({fields:{number:{element:"#card-number",placeholder:"**** **** **** ****"},expirationDate:{element:"#card-expiration-date",placeholder:"MM / YY"},ccv:{element:"#card-ccv",placeholder:"後三碼"}},styles:{".valid":{color:"green"},".invalid":{color:"red"}}})}setup(){this.setupSdk(),this.setupCard()}getPrime(){return new Promise(((t,e)=>{window.TPDirect.card.getPrime((i=>{0===i.status?t(i.card.prime):e("付款資料有誤")}))}))}get canGetPrime(){return window.TPDirect.card.getTappayFieldsStatus().canGetPrime}get cannotGetPrimeReason(){const t=window.TPDirect.card.getTappayFieldsStatus();return 1===t.status.number?"請輸入信用卡號碼":2===t.status.number?"信用卡號碼有誤":1===t.status.expiry?"請輸入有效期限":2===t.status.expiry?"有效期限有誤":1===t.status.ccv?"請輸入安全碼":2===t.status.ccv?"安全碼有誤":void 0}})})();